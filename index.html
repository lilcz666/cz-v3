<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gemini V5.0 [COMMANDER]</title>
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --blue: #007aff;
            --green: #34c759;
            --red: #ff3b30;
            --yellow: #ffcc00;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --radius: 18px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 16px; }

        /* é¡¶éƒ¨çŠ¶æ€ */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .logo { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; }
        .status-pill { 
            background: var(--card); padding: 5px 12px; border-radius: 20px; 
            box-shadow: var(--shadow); font-size: 0.7rem; font-weight: 700; color: var(--blue);
            display: flex; align-items: center; gap: 5px;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--blue); animation: pulse 1.5s infinite; }

        /* å¡ç‰‡é€šç”¨ */
        .card {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 20px;
            position: relative;
        }
        .card-title { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; }

        /* 1. æˆ˜æœ¯è·¯å¾„å¡ */
        .tac-step { display: flex; align-items: flex-start; margin-bottom: 12px; font-size: 0.9rem; }
        .step-num { 
            background: var(--text-main); color: #fff; width: 18px; height: 18px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 0.65rem; font-weight: bold; margin-right: 10px; flex-shrink: 0; margin-top: 2px;
        }
        .step-content { line-height: 1.4; flex: 1; }
        .highlight { font-weight: 800; color: var(--text-main); font-size: 1.1rem; margin: 0 2px; }
        .warn-text { color: var(--red); font-weight: 700; text-decoration: line-through; }
        .reason { display: block; font-size: 0.7rem; color: #86868b; margin-top: 3px; }

        /* 2. æƒé‡é¢æ¿ */
        .weight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .w-box { text-align: center; padding: 12px 5px; border-radius: 12px; background: #f9f9f9; border: 1px solid rgba(0,0,0,0.03); }
        .w-label { font-size: 0.7rem; color: var(--text-sub); }
        .w-score { font-size: 1.4rem; font-weight: 800; margin: 4px 0; }
        .w-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; }
        
        .tag-main { background: rgba(0,122,255,0.1); color: var(--blue); }
        .tag-def { background: rgba(255,204,0,0.2); color: #c49504; }
        .tag-kill { background: rgba(255,59,48,0.1); color: var(--red); }

        /* èƒ½é‡æ¡ */
        .bar-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.75rem; font-weight: 600; }
        .track { flex: 1; height: 6px; background: #f2f2f7; border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; border-radius: 3px; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

        /* 3. æ·±åº¦è§£æ */
        .analysis-box {
            font-size: 0.8rem; line-height: 1.6; color: #333; 
            background: #f9f9f9; padding: 12px; border-radius: 10px; border-left: 3px solid var(--text-main);
            font-family: monospace; white-space: pre-wrap;
        }

        /* 4. å¤ç›˜åˆ—è¡¨ */
        .hist-list { display: flex; flex-direction: column; gap: 0; }
        .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .hist-item:last-child { border-bottom: none; }
        .res-pill { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; min-width: 40px; text-align: center; }
        
        /* ä¸¥æ ¼æ‰§è¡Œä½ çš„é¢œè‰²æ ‡å‡† */
        .st-hit { background: var(--green); color: #fff; } /* ä¸»åŠ›ä¸­ */
        .st-def { background: var(--yellow); color: #000; } /* é˜²å®ˆä¸­ */
        .st-miss { background: var(--red); color: #fff; }  /* æ€ç»„å‡º/åç¦» */

        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* é¢œè‰²è¾…åŠ© */
        .c-main { color: var(--blue); }
        .c-def { color: #d4a000; }
        .c-kill { color: var(--red); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div class="logo">GEMINI V5.0</div>
        <div class="status-pill"><div class="dot"></div> <span id="timer">SYNCING</span></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ”¥ æ ¸å¿ƒæˆ˜æœ¯è·¯å¾„ / TACTICS</div>
        
        <div class="tac-step">
            <div class="step-num">1</div>
            <div class="step-content">
                <strong>ä¸»åŠ›å‹åˆ¶ (Main):</strong> <span id="txtMain" class="highlight c-main">--</span><br>
                <span id="reasonMain" class="reason">ç­‰å¾…æ•°æ®è¾“å…¥...</span>
            </div>
        </div>
        
        <div class="tac-step">
            <div class="step-num">2</div>
            <div class="step-content">
                <strong>å£è¢‹æ‹¦æˆª (Defense):</strong> <span id="txtDef" class="highlight c-def">--</span><br>
                <span id="reasonDef" class="reason">é˜²å®ˆå¯¹å†²ä½</span>
            </div>
        </div>

        <div class="tac-step">
            <div class="step-num">3</div>
            <div class="step-content">
                <strong>ç»æ€åºŸç»„ (Kill):</strong> <span id="txtKill" class="warn-text">--</span><br>
                <span class="reason">æƒé‡å«åº•ï¼Œåšå†³é¿å¼€</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <span>ğŸ“Š èƒ½é‡æƒé‡ (TOTAL: 10.0)</span>
        </div>
        
        <div class="bar-wrap"><span style="width:30px">å¤§</span><div class="track"><div id="barBig" class="fill" style="background:var(--red)"></div></div><span id="vBig">0.0</span></div>
        <div class="bar-wrap"><span style="width:30px">å°</span><div class="track"><div id="barSml" class="fill" style="background:var(--green)"></div></div><span id="vSml">0.0</span></div>
        <div class="bar-wrap"><span style="width:30px">å•</span><div class="track"><div id="barOdd" class="fill" style="background:var(--blue)"></div></div><span id="vOdd">0.0</span></div>
        <div class="bar-wrap"><span style="width:30px">åŒ</span><div class="track"><div id="barEvn" class="fill" style="background:var(--yellow)"></div></div><span id="vEvn">0.0</span></div>
        
        <div style="height:1px; background:#f0f0f0; margin:20px 0;"></div>
        
        <div class="card-title">ğŸ§© ç»„åˆæƒé‡ (TOTAL: 10.0)</div>
        <div class="weight-grid" id="comboGrid">
            </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ§  é€»è¾‘æ·±åº¦è§£æ / LOGIC</div>
        <div class="analysis-box" id="analysisText">LOADING KERNEL...</div>
    </div>

    <div class="card">
        <div class="card-title">âš”ï¸ æˆ˜æœå¤ç›˜ (è¿‘10æœŸ)</div>
        <div id="histList" class="hist-list"></div>
    </div>

</div>

<script>
    // --- V5.0 æŒ‡ä»¤é›†å¸¸é‡ ---
    const C = {
        SQRT_OSC: 28.5, SQRT_ADD: 7.5515, FISS_GOLD: 1.6180, SCAL_GOLD: 3.81966,
        TRI_DIV: 42.75, REV_GOLD: 0.61803, WARN_DIV: 6.6666, EXT_DIV: 2.2222
    };

    const STATE = {
        api: "https://pc28.help/kj.json?limit=50",
        history: [],
        refresh: 20
    };

    const KERNEL = {
        getD: (n) => parseInt(n.toFixed(6).split('.')[1][0]),
        getI: (n) => Math.floor(n),

        // æ ¸å¿ƒè¿ç®—ï¼šè®¡ç®—åŸå§‹åˆ†æ•°
        calcRaw: (n1, n2, n3, sum, history, isCompensationActive) => {
            let w = { b:0, s:0, o:0, e:0 };
            let logs = [];

            // 1. Algo 19 (P0 æ‰‹æœ¯åˆ€)
            let r19 = (Math.sqrt(n1**2+n2**2+n3**2))/C.SCAL_GOLD;
            let d19 = KERNEL.getD(r19);
            let i19 = KERNEL.getI(r19);
            if([7,8,9].includes(d19)) { w.b+=10; logs.push(`> [Algo19] D=${d19} é‡åŠ›ä½æŒ‡å‘å¤§`); }
            else if([0,1,2].includes(d19)) { w.s+=10; logs.push(`> [Algo19] D=${d19} é‡åŠ›ä½æŒ‡å‘å°`); }
            
            if([3,4,5,6].includes(d19)) {
                if((i19+n1+n2)%3===0) { w.o+=10; logs.push(`> [Algo19] ç†µå€¼é”å®šå•`); }
                else { w.e+=10; logs.push(`> [Algo19] ç†µå€¼é”å®šåŒ`); }
            }

            // 2. Algo 16 (P1 éœ‡è¡)
            let isDiving = Math.abs(n1-n2)>8;
            let r16 = Math.sqrt(n1*n2*(1+Math.abs(n1-n2)/C.SQRT_OSC)+C.SQRT_ADD);
            let d16 = KERNEL.getD(r16);
            let s16 = isDiving ? 10 : 5;
            if(d16>=5) w.b+=s16; else w.s+=s16;
            if(isDiving) logs.push(`> [Algo16] è·³æ°´ç‹¬è£è§¦å‘ (+10)`);

            // 3. Algo 14 (P1 è£‚å˜)
            let r14 = Math.sqrt(((n1-n2)**2) + ((n3**2)/(sum+1)) + C.FISS_GOLD);
            let d14 = KERNEL.getD(r14);
            let w14 = 4;
            if(d14<=4) { // é¡º
                if(w.b>w.s) w.b+=w14; else w.s+=w14;
            } else { // è£‚
                if(w.b>w.s) w.s+=w14; else w.b+=w14;
            }

            // 4. å¸¸è§„ç®—æ³•
            let r18 = ((n1+3.1415)*(n2+2.7182)*(n3+1.4142))/C.TRI_DIV;
            let u18 = Math.floor(r18)%10;
            (u18%2!==0) ? w.o+=3 : w.e+=3;

            let r2 = (n1+C.REV_GOLD)*C.REV_GOLD;
            (Math.floor(r2)%2===0) ? w.o+=3 : w.e+=3;

            // 5. Algo 3 (åè¶‹åŠ¿è­¦æŠ¥)
            let r3 = (n1+n2+n3)/C.WARN_DIV;
            let d3 = KERNEL.getD(r3);
            if(d3===0 || d3===6) {
                logs.push(`> âš ï¸ [Algo3] è§¦å‘åè¶‹åŠ¿è­¦æŠ¥ï¼Œæƒ¯æ€§æ¸…ç©º`);
                w.b*=0.5; w.s*=0.5; w.o*=0.5; w.e*=0.5;
            }

            // 6. å°´å°¬åŒºä¿®æ­£ (7.5-8.5)
            // å…ˆè®¡ç®—ä¸€ä¸ªä¸´æ—¶æœ€å¤§åˆ†
            let tempMax = Math.max(w.b,w.s,w.o,w.e);
            if(tempMax >= 7.5 && tempMax <= 8.5) {
                logs.push(`> [ä¿®æ­£] æƒé‡å¡åœ¨å°´å°¬åŒºï¼ŒMOD3 å¼ºé”`);
                let lock = (i19+n1+n2)%3;
                if(lock===0) w.o+=5; else w.e+=5;
            }

            // 7. è·¨å‘¨æœŸè¡¥å¿ (æ­»ç£•æ¨¡å¼) - è¯»å–æœ¬åœ°ç¼“å­˜
            if(isCompensationActive) {
                let lastMiss = localStorage.getItem('v5_last_miss_dir');
                if(lastMiss) {
                    logs.push(`> [å¤ä»‡] æ¿€æ´»æ­»ç£•è¡¥å¿ (+2.0) æŒ‡å‘ ${lastMiss}`);
                    if(lastMiss.includes('å¤§')) w.b+=2;
                    if(lastMiss.includes('å°')) w.s+=2;
                    if(lastMiss.includes('å•')) w.o+=2;
                    if(lastMiss.includes('åŒ')) w.e+=2;
                }
            }

            return { w, logs };
        },

        // å½’ä¸€åŒ–å¤„ç† (10åˆ†åˆ¶)
        normalize: (rawW) => {
            let total = rawW.b + rawW.s + rawW.o + rawW.e;
            if(total === 0) total = 1;
            
            // å½’ä¸€åŒ–å•é¡¹
            let nW = {
                b: (rawW.b / total) * 10,
                s: (rawW.s / total) * 10,
                o: (rawW.o / total) * 10,
                e: (rawW.e / total) * 10
            };

            // è®¡ç®—åŸå§‹ç»„åˆåˆ†
            let rawCombos = [
                { name: "å¤§å•", s: rawW.b + rawW.o },
                { name: "å¤§åŒ", s: rawW.b + rawW.e },
                { name: "å°å•", s: rawW.s + rawW.o },
                { name: "å°åŒ", s: rawW.s + rawW.e }
            ];

            // å½’ä¸€åŒ–ç»„åˆåˆ† (æ€»å’Œ=10)
            let comboTotal = rawCombos.reduce((a,b) => a + b.s, 0);
            if(comboTotal === 0) comboTotal = 1;

            let nCombos = rawCombos.map(c => ({
                name: c.name,
                s: (c.s / comboTotal) * 10
            }));

            // æ’åº
            nCombos.sort((a,b) => b.s - a.s);

            return { nW, nCombos };
        }
    };

    // --- Controller ---
    async function sync() {
        document.getElementById('timer').innerText = "SYNC...";
        try {
            const t = Date.now();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(STATE.api + "&t=" + t)}`);
            const json = await res.json();
            const data = JSON.parse(json.contents).data;
            if(data && data.length > 0) {
                STATE.history = data.map(i => {
                    const nums = i.opennum.split('+').map(Number);
                    return { q: i.qihao, n1: nums[0], n2: nums[1], n3: nums[2], sum: parseInt(i.sum) };
                });
                render();
            }
        } catch(e) { console.error(e); }
        startTimer();
    }

    function render() {
        const list = STATE.history;
        if(list.length < 5) return;

        const cur = list[0];
        // 1. è®¡ç®—å½“å‰é¢„æµ‹ (å¼€å¯è¡¥å¿)
        const rawRes = KERNEL.calcRaw(cur.n1, cur.n2, cur.n3, cur.sum, list, true);
        const finalRes = KERNEL.normalize(rawRes.w);
        
        // --- æ¸²æŸ“æˆ˜æœ¯è·¯å¾„ ---
        const main = finalRes.nCombos[0];
        const sub = finalRes.nCombos[1];
        const def = finalRes.nCombos[2];
        const kill = finalRes.nCombos[3];

        document.getElementById('txtMain').innerText = `${main.name} / ${sub.name}`;
        document.getElementById('reasonMain').innerText = `ç»¼åˆæƒé‡è¯„åˆ† ${main.s.toFixed(1)}ï¼ŒV5 ç®—æ³•ä¸»åŠ›æŒ‡å‘ã€‚`;
        
        document.getElementById('txtDef').innerText = def.name;
        document.getElementById('reasonDef').innerText = `é˜²å®ˆæƒé‡ ${def.s.toFixed(1)}ï¼Œæ‹¦æˆªçœŸç©ºåŒºã€‚`;

        document.getElementById('txtKill').innerText = kill.name;

        // --- æ¸²æŸ“æƒé‡ (10åˆ†åˆ¶) ---
        // å•é¡¹
        const drawBar = (id, val, color) => {
            document.getElementById('bar'+id).style.width = Math.min(100, val*10) + '%';
            document.getElementById('v'+id).innerText = val.toFixed(1);
        };
        drawBar('Big', finalRes.nW.b); drawBar('Sml', finalRes.nW.s);
        drawBar('Odd', finalRes.nW.o); drawBar('Evn', finalRes.nW.e);

        // ç»„åˆ
        const grid = document.getElementById('comboGrid');
        grid.innerHTML = '';
        finalRes.nCombos.forEach((c, idx) => {
            let tag = idx <= 1 ? 'tag-main' : (idx===2 ? 'tag-def' : 'tag-kill');
            let label = idx <= 1 ? 'ä¸»åŠ›' : (idx===2 ? 'é˜²å®ˆ' : 'æ€ç»„');
            grid.innerHTML += `
                <div class="w-box">
                    <div class="w-label">${c.name} <span class="w-tag ${tag}">${label}</span></div>
                    <div class="w-score">${c.s.toFixed(1)}</div>
                </div>`;
        });

        // --- æ¸²æŸ“æ—¥å¿— ---
        document.getElementById('analysisText').innerHTML = rawRes.logs.join('\n');

        // --- æ¸²æŸ“å¤ç›˜ (å›æµ‹ + è¡¥å¿çŠ¶æ€æ›´æ–°) ---
        const hBox = document.getElementById('histList');
        hBox.innerHTML = '';
        
        // æ£€æŸ¥ä¸Šä¸€æœŸæ˜¯å¦å‘½ä¸­ï¼Œç”¨äºè®¾ç½® LocalStorage
        let lastIssueHit = false;
        let lastIssueMainDir = '';

        // éå†å›æµ‹
        for(let i=0; i<10; i++) {
            const target = list[i];
            const prev = list[i+1];
            
            // å›æµ‹æ—¶ä¸å¼€å¯è¡¥å¿ (ä¿æŒçº¯å‡€ç®—æ³•éªŒè¯ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©å¼€å¯ä»¥éªŒè¯è¿ç»­æ€§)
            // è¿™é‡Œä¸ºäº†éªŒè¯ç®—æ³•æœ¬èº«çš„å‡†ç¡®æ€§ï¼Œæš‚ä¸å¼€å¯å†å²è¡¥å¿
            const simRaw = KERNEL.calcRaw(prev.n1, prev.n2, prev.n3, prev.sum, list.slice(i+1), false);
            const simFinal = KERNEL.normalize(simRaw.w);
            
            const actBs = target.sum >= 14 ? 'å¤§' : 'å°';
            const actOe = target.sum % 2 !== 0 ? 'å•' : 'åŒ';
            const actName = actBs + actOe;

            // åˆ¤å®š
            let status = '';
            let styleClass = '';
            
            // å‘½ä¸­: ä¸»åŠ›1æˆ–ä¸»åŠ›2
            if(simFinal.nCombos[0].name === actName || simFinal.nCombos[1].name === actName) {
                status = 'å‘½ä¸­'; styleClass = 'st-hit';
                if(i===0) lastIssueHit = true;
            } 
            // é˜²å®ˆ: ç¬¬3å
            else if(simFinal.nCombos[2].name === actName) {
                status = 'é˜²å®ˆ'; styleClass = 'st-def';
            }
            // åç¦»: æ€ç»„
            else {
                status = 'åç¦»'; styleClass = 'st-miss';
            }

            if(i===0) lastIssueMainDir = simFinal.nCombos[0].name; // è®°å½•ä¸Šä¸€æœŸä¸»åŠ›æ–¹å‘

            hBox.innerHTML += `
                <div class="hist-item">
                    <div>
                        <span style="font-weight:700;">${target.q.slice(-4)}æœŸ</span> 
                        <span style="color:#888; font-size:0.8rem;">[${target.sum}] ${actName}</span>
                    </div>
                    <span class="res-pill ${styleClass}">${status}</span>
                </div>`;
        }

        // æ›´æ–°æ­»ç£•è¡¥å¿é€»è¾‘ (æŒä¹…åŒ–)
        if(!lastIssueHit && lastIssueMainDir) {
            // ä¸Šä¸€æŠŠæ²¡ä¸­ï¼ŒæŠŠä¸Šä¸€æŠŠçš„ä¸»æ”»æ–¹å‘å­˜èµ·æ¥ï¼Œä¸‹ä¸€æŠŠå¼ºåˆ¶åŠ åˆ†
            localStorage.setItem('v5_last_miss_dir', lastIssueMainDir);
        } else {
            // ä¸­äº†å°±æ¸…é™¤ä»‡æ¨
            localStorage.removeItem('v5_last_miss_dir');
        }
    }

    function startTimer() {
        let t = STATE.refresh;
        const tmr = setInterval(() => {
            t--;
            document.getElementById('timer').innerText = `NEXT ${t}s`;
            if(t<=0) { clearInterval(tmr); sync(); }
        }, 1000);
    }

    window.onload = sync;
</script>
</body>
</html>
