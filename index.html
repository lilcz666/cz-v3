<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gemini V5.0 [FULL KERNEL]</title>
    <style>
        :root {
            --bg: #f2f2f7; /* iOS System Gray 6 */
            --card: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --blue: #007aff;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9500;
            --gray: #d1d1d6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 18px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 20px; }

        /* È°∂ÈÉ®Ê†è */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 4px; }
        .title { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
        .status-pill { 
            background: #fff; padding: 6px 12px; border-radius: 20px; 
            font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray); transition: 0.3s; }
        .dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
        .dot.warn { background: var(--red); box-shadow: 0 0 6px var(--red); animation: pulse 1s infinite; }

        /* ÈÄöÁî®Âç°Áâá */
        .card {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 20px;
            position: relative; overflow: hidden;
        }
        .card-head { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 15px; display: flex; justify-content: space-between; }

        /* Ê†∏ÂøÉÊàò‰ª§Âå∫ */
        .hero { text-align: center; padding: 30px 20px; }
        .issue-info { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; }
        .main-pred { font-size: 48px; font-weight: 900; line-height: 1; margin: 10px 0; letter-spacing: -1px; }
        .sub-pred { font-size: 16px; font-weight: 600; color: var(--text-secondary); }
        
        /* ÊàòÊúØ‰∏âÈ°π Grid */
        .tac-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .tac-box { background: var(--bg); padding: 12px; border-radius: 12px; text-align: center; }
        .tac-lbl { font-size: 10px; color: var(--text-secondary); font-weight: 700; margin-bottom: 4px; }
        .tac-val { font-size: 15px; font-weight: 800; }
        .kill-zone { grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 8px; opacity: 0.6; }

        /* ÁÆóÊ≥ïÁü©ÈòµË°® (Á¨¨12ÊÆµË¶ÅÊ±Ç) */
        .algo-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .algo-table td { padding: 6px; border-bottom: 1px solid #f2f2f7; text-align: center; }
        .algo-table th { padding: 6px; color: var(--text-secondary); font-weight: 600; font-size: 10px; }
        .p0-row { background: rgba(255, 59, 48, 0.05); }

        /* ËÉΩÈáèÊù° */
        .bars { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .bar-row { display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: 600; }
        .track { flex: 1; height: 6px; background: #f2f2f7; border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        
        /* ÂéÜÂè≤ÂàóË°® */
        .hist-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f2f2f7; font-size: 12px; }
        .res-tag { padding: 3px 8px; border-radius: 6px; font-weight: 700; font-size: 10px; }
        .hit { background: rgba(52,199,89,0.15); color: var(--green); }
        .miss { background: rgba(255,59,48,0.15); color: var(--red); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .c-red { color: var(--red); } .c-green { color: var(--green); } .c-blue { color: var(--blue); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div class="title">Gemini V5.0</div>
        <div class="status-pill">
            <div id="statusDot" class="dot"></div>
            <span id="timer">LOADING</span>
        </div>
    </div>

    <div class="card hero">
        <div class="issue-info">TARGET: <span id="targetIssue" style="color:var(--blue); font-weight:700;">--</span></div>
        <div id="mainPred" class="main-pred">--</div>
        <div id="confidence" class="sub-pred">Confidence: 0%</div>

        <div class="tac-grid">
            <div class="tac-box">
                <div class="tac-lbl">üî• MAIN ATTACK</div>
                <div id="tacMain" class="tac-val c-red">--</div>
            </div>
            <div class="tac-box">
                <div class="tac-lbl">üõ°Ô∏è DEFENSE</div>
                <div id="tacDef" class="tac-val c-green">--</div>
            </div>
            <div class="tac-box kill-zone">
                <span style="font-size:10px; font-weight:700;">üíÄ KILL ZONE</span>
                <span id="tacKill" style="font-weight:700; text-decoration:line-through;">--</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-head">
            <span>ENERGY WEIGHTS</span>
            <span id="stateText" style="font-size:10px; color:var(--orange);"></span>
        </div>
        <div class="bars">
            <div class="bar-row"><span style="width:25px">Big</span><div class="track"><div id="barBig" class="fill" style="background:var(--red); width:0%"></div></div><span id="valBig">0</span></div>
            <div class="bar-row"><span style="width:25px">Sml</span><div class="track"><div id="barSml" class="fill" style="background:var(--green); width:0%"></div></div><span id="valSml">0</span></div>
            <div class="bar-row"><span style="width:25px">Odd</span><div class="track"><div id="barOdd" class="fill" style="background:var(--blue); width:0%"></div></div><span id="valOdd">0</span></div>
            <div class="bar-row"><span style="width:25px">Evn</span><div class="track"><div id="barEvn" class="fill" style="background:#ffcc00; width:0%"></div></div><span id="valEvn">0</span></div>
        </div>
    </div>

    <div class="card" style="padding: 10px 15px;">
        <div class="card-head" style="margin-bottom:5px;">ALGO MATRIX (7-SWORD)</div>
        <table class="algo-table">
            <thead><tr><th>ID</th><th>Raw</th><th>Dir</th><th>P-Level</th></tr></thead>
            <tbody id="matrixBody"></tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-head">HISTORY & REVIEW</div>
        <div id="histList"></div>
    </div>

</div>

<script>
    // --- Êåá‰ª§ÈõÜÂèÇÊï∞ÈîÅÂÆö (Section 1 - 10) ---
    const C = {
        SQRT_OSC: 28.5,     // Algo 16
        SQRT_ADD: 7.5515,   // Algo 16
        FISS_GOLD: 1.6180,  // Algo 14
        SCAL_GOLD: 3.81966, // Algo 19
        TRI_DIV: 42.75,     // Algo 18
        REV_GOLD: 0.61803,  // Algo 2
        WARN_DIV: 6.6666,   // Algo 3
        EXT_DIV: 2.2222     // Algo 10
    };

    const STATE = {
        api: "https://pc28.help/kj.json?limit=50",
        history: [],
        refresh: 20,
        lastMiss: false // Áî®‰∫éÁ¨¨14ÊÆµË°•ÂÅø
    };

    const KERNEL = {
        getD: (n) => parseInt(n.toFixed(6).split('.')[1][0]),
        getI: (n) => Math.floor(n),

        // --- Ê†∏ÂøÉËÆ°ÁÆóÂºïÊìé ---
        calculate: (n1, n2, n3, sum, history) => {
            let w = { b: 0, s: 0, o: 0, e: 0 };
            let matrix = [];
            let status = { warning: false, dragon: false, diving: false, p0: null };

            // ËæÖÂä©ÔºöÊ£ÄÊµãÈæôÂ±Ä (4Ëøû‰ª•‰∏ä) - Section 11
            // ÁÆÄÂçïÊ£ÄÊµãÂ§ßÂ∞èÈæô
            let lastType = (history[1].sum >= 14) ? 'Big' : 'Small';
            let dragonCount = 1;
            for(let i=2; i<Math.min(10, history.length); i++) {
                let t = (history[i].sum >= 14) ? 'Big' : 'Small';
                if(t === lastType) dragonCount++; else break;
            }
            if(dragonCount >= 4) status.dragon = true;
            if(Math.abs(n1 - n2) > 8) status.diving = true; // Section 11

            // 1. Algo 16 (P1) - Section 2, 3
            let r16 = Math.sqrt(n1*n2*(1+Math.abs(n1-n2)/C.SQRT_OSC)+C.SQRT_ADD);
            let d16 = KERNEL.getD(r16);
            let p16 = (n1>=20 || n1<=6) ? 'P0' : 'P1';
            let dir16 = (d16>=5) ? 'Â§ß' : 'Â∞è';
            // ÈÄªËæë: ÊûÅÂÄºÊàñË∑≥Ê∞¥ -> P0Áã¨Ë£Å (Section 11)
            if(status.diving) { p16 = 'P0(Dive)'; status.p0 = '16'; }
            if(p16.startsWith('P0')) { 
                if(dir16==='Â§ß') w.b+=50; else w.s+=50; // Áã¨Ë£ÅÂä†ÂàÜ
            } else {
                if(dir16==='Â§ß') w.b+=4; else w.s+=4;
            }
            matrix.push({id:16, v:d16, d:dir16, p:p16});

            // 2. Algo 14 (P1) - Section 4
            let r14 = Math.sqrt(((n1-n2)**2) + ((n3**2)/(sum+1)) + C.FISS_GOLD);
            let d14 = KERNEL.getD(r14);
            let dir14 = (d14<=4) ? 'È°∫' : 'Ë£Ç';
            let w14 = (status.dragon) ? 6 : 4; // ÈæôÂ±ÄÊùÉÈáç 1.5ÂÄç (4*1.5=6)
            // Section 11: ÈæôÂ±ÄÈîÅÂÆö P0
            if(status.dragon && !status.p0) {
                w14 = 50; status.p0 = '14'; // Áã¨Ë£Å
            }
            if(dir14==='È°∫') { if(w.b>w.s) w.b+=w14; else w.s+=w14; } // È°∫Âäø
            else { if(w.b>w.s) w.s+=w14; else w.b+=w14; } // Ë£ÇÂèò
            matrix.push({id:14, v:d14, d:dir14, p:status.dragon?'P0(Drg)':'P1'});

            // 3. Algo 19 (P0) - Section 5, 6
            let r19 = (Math.sqrt(n1**2+n2**2+n3**2))/C.SCAL_GOLD;
            let d19 = KERNEL.getD(r19);
            let i19 = KERNEL.getI(r19);
            let dir19 = '-';
            // Èô§ÈùûÂ∑≤Ë¢´Áã¨Ë£ÅÔºåÂê¶ÂàôÊâßË°å
            if(!status.p0) {
                if([7,8,9].includes(d19)) { w.b+=10; dir19='Â§ß'; }
                else if([0,1,2].includes(d19)) { w.s+=10; dir19='Â∞è'; }
                // ÁÜµÂà§ÂÆö
                if([3,4,5,6].includes(d19)) {
                    if((i19+n1+n2)%3===0) { w.o+=10; dir19='Âçï(En)'; }
                    else { w.e+=10; dir19='Âèå(En)'; }
                }
            }
            matrix.push({id:19, v:d19, d:dir19, p:'P0'});

            // 4. Algo 18 (P2) - Section 7
            let r18 = ((n1+3.1415)*(n2+2.7182)*(n3+1.4142))/C.TRI_DIV;
            let d18 = KERNEL.getD(r18);
            let u18 = Math.floor(r18)%10;
            if(!status.p0) {
                if(d18>=5) w.b+=3; else w.s+=3;
                if(u18%2!==0) w.o+=3; else w.e+=3;
            }
            matrix.push({id:18, v:d18, d:`${d18>=5?'Â§ß':'Â∞è'}/${u18%2!==0?'Âçï':'Âèå'}`, p:'P2'});

            // 5. Algo 2 (P3) - Section 8
            let r2 = (n1+C.REV_GOLD)*C.REV_GOLD;
            let i2 = Math.floor(r2);
            let dir2 = (i2%2===0)?'Âçï':'Âèå'; // ÂèçÈÄªËæë
            if(!status.p0) {
                if(dir2==='Âçï') w.o+=3; else w.e+=3;
            }
            matrix.push({id:2, v:KERNEL.getD(r2), d:dir2, p:'P3'});

            // 6. Algo 3 (P3) - Section 9 (ÂèòÁõò)
            let r3 = (n1+n2+n3)/C.WARN_DIV;
            let d3 = KERNEL.getD(r3);
            let dir3 = '-';
            if(d3===0 || d3===6) {
                status.warning = true;
                // Ê∏ÖÁ©∫ÊÉØÊÄß: ÊâÄÊúâÊùÉÈáçÂΩíÈõ∂/ÂáèÂçä (ËøôÈáåÊâßË°åÂº∫ÂäõÊäëÂà∂)
                w.b*=0.2; w.s*=0.2; w.o*=0.2; w.e*=0.2;
                dir3 = '‚ö†Ô∏èALERT';
            } else if(!status.p0) {
                if([3,5,7,9].includes(d3)) { w.b+=3; dir3='Â§ß'; }
                if([1,2,4,8].includes(d3)) { w.s+=3; dir3='Â∞è'; }
            }
            matrix.push({id:3, v:d3, d:dir3, p:'P3'});

            // 7. Algo 10 (P4) - Section 10
            let r10 = 280/(n1+C.EXT_DIV);
            let dec10 = r10 - Math.floor(r10);
            let dir10 = (dec10>0.666)?'Áª≠':'Èúá';
            if(dec10 < 0.333) { // ÂèçÂºπ
                if(w.b>w.s) w.s+=4; else w.b+=4; // Â∏ÆÂº±
                dir10 = 'ÂèçÂºπ';
            }
            matrix.push({id:10, v:dec10.toFixed(2), d:dir10, p:'P4'});

            // --- Section 14: Ê†°ÂáÜ ---
            // 1. ‰∏äÊúüÂÅèÁ¶ªË°•ÂÅø (Ë∑®Âë®ÊúüÊà™ÊùÄ)
            if(STATE.lastMiss) {
                // ÊâæÂá∫ÂΩìÂâçÊúÄÈ´òÂàÜÔºåÂº∫Âà∂Âä†ÂàÜ
                if(w.b > w.s) w.b += 1.5; else w.s += 1.5;
            }
            // 2. Â∞¥Â∞¨Âå∫Âº∫Âà∂ÈîÅÊ≠ª (7.5 - 8.5)
            let maxScore = Math.max(w.b, w.s, w.o, w.e);
            if(maxScore >= 7.5 && maxScore <= 8.5) {
                let modLock = (i19 + n1 + n2) % 3; // Â§çÁî®ÁÜµÈÄªËæë
                if(modLock === 0) w.o += 5; else w.e += 5;
            }

            // ÁªÑÂêàËÆ°ÁÆó
            let combos = [
                { name: "Â§ßÂçï", s: w.b+w.o }, { name: "Â§ßÂèå", s: w.b+w.e },
                { name: "Â∞èÂçï", s: w.s+w.o }, { name: "Â∞èÂèå", s: w.s+w.e }
            ];
            combos.sort((a,b) => b.s - a.s);

            return { w, combos, matrix, status };
        }
    };

    // --- Controller ---
    async function sync() {
        document.getElementById('timer').innerText = "SYNC...";
        try {
            const t = Date.now();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(STATE.api + "&t=" + t)}`);
            const json = await res.json();
            const data = JSON.parse(json.contents).data;
            if(data && data.length > 0) {
                STATE.history = data.map(i => {
                    const nums = i.opennum.split('+').map(Number);
                    return { q: i.qihao, n1: nums[0], n2: nums[1], n3: nums[2], sum: parseInt(i.sum) };
                });
                render();
            }
        } catch(e) { console.error(e); }
        startTimer();
    }

    function render() {
        const list = STATE.history;
        if(list.length < 5) return;

        // 1. È¢ÑÊµãÊú¨Êúü (Âü∫‰∫é list[0])
        const cur = list[0];
        const result = KERNEL.calculate(cur.n1, cur.n2, cur.n3, cur.sum, list);
        
        // Êõ¥Êñ∞ UI
        document.getElementById('targetIssue').innerText = (BigInt(cur.q)+1n).toString();
        document.getElementById('mainPred').innerText = result.combos[0].name.charAt(0);
        document.getElementById('confidence').innerText = `Conf: ${Math.min(99, result.combos[0].s*3).toFixed(0)}%`;
        
        document.getElementById('tacMain').innerText = `${result.combos[0].name} / ${result.combos[1].name}`;
        document.getElementById('tacDef').innerText = result.combos[2].name;
        document.getElementById('tacKill').innerText = result.combos[3].name;

        // Áä∂ÊÄÅÊåáÁ§∫
        const dot = document.getElementById('statusDot');
        const stTxt = document.getElementById('stateText');
        if(result.status.warning) { 
            dot.className = "dot warn"; stTxt.innerText = "WARNING: INERTIA CLEARED";
        } else if(result.status.p0) {
            dot.className = "dot active"; stTxt.innerText = `DICTATOR ACTIVE (Algo${result.status.p0})`;
        } else {
            dot.className = "dot active"; stTxt.innerText = "NORMAL";
        }

        // ËÉΩÈáèÊù°
        const setBar = (id, val) => {
            document.getElementById('bar'+id).style.width = Math.min(100, val*3) + '%';
            document.getElementById('val'+id).innerText = val.toFixed(1);
        };
        setBar('Big', result.w.b); setBar('Sml', result.w.s);
        setBar('Odd', result.w.o); setBar('Evn', result.w.e);

        // Áü©ÈòµË°®
        const mBody = document.getElementById('matrixBody');
        mBody.innerHTML = '';
        result.matrix.forEach(m => {
            mBody.innerHTML += `<tr class="${m.p.includes('P0')?'p0-row':''}">
                <td>${m.id}</td><td>${m.v}</td><td>${m.d}</td><td>${m.p}</td>
            </tr>`;
        });

        // ÂéÜÂè≤Â§çÁõò (Sec 13)
        const hBox = document.getElementById('histList');
        hBox.innerHTML = '';
        let missCount = 0;
        
        for(let i=0; i<10; i++) {
            const target = list[i];
            const prev = list[i+1];
            // ÂõûÊµã
            const sim = KERNEL.calculate(prev.n1, prev.n2, prev.n3, prev.sum, list.slice(i+1));
            
            const actBs = target.sum >= 14 ? 'Â§ß' : 'Â∞è';
            const actOe = target.sum % 2 !== 0 ? 'Âçï' : 'Âèå';
            const actName = actBs + actOe;
            
            const hit = (sim.combos[0].name === actName || sim.combos[1].name === actName);
            if(i===0 && !hit) STATE.lastMiss = true; // ËÆ∞ÂΩï‰∏ä‰∏ÄÊääÊòØÂê¶MissÔºåÁî®‰∫é‰∏ã‰∏ÄÊääË°•ÂÅø
            else if(i===0) STATE.lastMiss = false;

            hBox.innerHTML += `<div class="hist-item">
                <span>${target.q.slice(-4)}Êúü [${target.sum}]</span>
                <span>
                    <span style="color:#8e8e93; margin-right:5px">${actName}</span>
                    <span class="res-tag ${hit?'hit':'miss'}">${hit?'ÂëΩ‰∏≠':'ÂÅèÁ¶ª'}</span>
                </span>
            </div>`;
        }
    }

    function startTimer() {
        let t = STATE.refresh;
        const tmr = setInterval(() => {
            t--;
            document.getElementById('timer').innerText = `NEXT ${t}s`;
            if(t<=0) { clearInterval(tmr); sync(); }
        }, 1000);
    }

    window.onload = sync;
</script>
</body>
</html>
