<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cz算法 V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #050505;
            --card-bg: rgba(20, 20, 23, 0.85);
            --card-border: rgba(255, 255, 255, 0.1);
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444; --success: #10b981;
            --purple: #8b5cf6; --cyan: #06b6d4;
            --text-main: #ffffff; --text-sub: #94a3b8;
            --font-ui: 'Rajdhani', sans-serif; --font-num: 'Roboto Mono', monospace;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), linear-gradient(0deg, #000000 0%, rgba(20,20,23,0) 100%);
            color: var(--text-main); font-family: var(--font-ui);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 24px 16px 60px 16px;
        }
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 24px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .brand { font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; color: #fff; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); font-weight: 800; }
        .status-badge { font-family: var(--font-num); font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 4px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--success); display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .pulse-dot { width: 6px; height: 6px; background: var(--success); box-shadow: 0 0 8px var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        .card { background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px; position: relative; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.5); }
        .card-label { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 16px; display: block; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .tac-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tac-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 16px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tac-box.main { grid-column: span 2; background: linear-gradient(135deg, rgba(59,130,246,0.1), transparent); border-color: rgba(59,130,246,0.3); }
        .tac-box.kill { background: linear-gradient(135deg, rgba(239,68,68,0.1), transparent); border-color: rgba(239,68,68,0.3); }
        .tac-title { font-size: 0.65rem; color: var(--text-sub); margin-bottom: 4px; letter-spacing: 1px; font-weight: 600; }
        .tac-val { font-family: var(--font-ui); font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; }
        .c-main { color: var(--primary); text-shadow: 0 0 15px rgba(59,130,246,0.4); }
        .c-def { color: var(--accent); }
        .c-kill { color: var(--danger); text-decoration: line-through; opacity: 0.7; }
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 16px; margin-top: 20px; }
        .hud-item { display: flex; flex-direction: column; gap: 6px; }
        .hud-head { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 700; color: var(--text-sub); }
        .hud-track { height: 6px; background: rgba(255,255,255,0.05); border-radius: 2px; overflow: hidden; }
        .hud-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; box-shadow: 0 0 8px currentColor; }
        .combo-row { display: flex; justify-content: space-between; margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.05); }
        .mini-stat { text-align: center; flex: 1; border-right: 1px solid rgba(255,255,255,0.05); }
        .mini-stat:last-child { border-right: none; }
        .ms-label { font-size: 0.6rem; color: var(--text-sub); display: block; margin-bottom: 4px; }
        .ms-val { font-family: var(--font-num); font-weight: 700; font-size: 0.9rem; }
        #histList { display: flex; flex-direction: column; gap: 8px; }
        .log-row { display: grid; grid-template-columns: 60px 1fr 60px; align-items: center; padding: 10px 14px; border-radius: 8px; background: rgba(255,255,255,0.02); font-family: var(--font-num); font-size: 0.8rem; border-left: 2px solid transparent; }
        .log-row:first-child { background: rgba(59,130,246,0.08); border-left-color: var(--primary); }
        .log-q { color: var(--text-sub); opacity: 0.8; }
        .log-r { text-align: center; font-weight: 700; color: #fff; }
        .tag-hit { color: var(--success); text-shadow: 0 0 8px rgba(16,185,129,0.3); }
        .tag-def { color: var(--accent); }
        .tag-miss { color: var(--danger); opacity: 0.8; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 12px 0; border-radius: 8px; text-align: center; }
        .stat-t { font-size: 0.6rem; color: var(--text-sub); display: block; margin-bottom: 4px; text-transform: uppercase; }
        .stat-v { font-family: var(--font-num); font-size: 1rem; font-weight: 700; color: #fff; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">CZ算法 <span>V3</span></div>
        <div class="status-badge"><div class="pulse-dot"></div> <span id="timer">SYNC</span></div>
    </div>

    <div class="card">
        <span class="card-label">TACTICAL DATA // 战术面板</span>
        <div class="tac-grid">
            <div class="tac-box main">
                <span class="tac-title">PRIORITY (主力)</span>
                <div id="tMain" class="tac-val c-main">-- / --</div>
            </div>
            <div class="tac-box">
                <span class="tac-title">DEFENSE (防守)</span>
                <div id="tDef" class="tac-val c-def">--</div>
            </div>
            <div class="tac-box kill">
                <span class="tac-title">KILL (杀组)</span>
                <div id="tKill" class="tac-val c-kill">--</div>
            </div>
        </div>
    </div>

    <div class="card">
        <span class="card-label">ENERGY MATRIX // 权重分布</span>
        <div class="hud-grid">
            <div class="hud-item">
                <div class="hud-head"><span>BIG</span> <span id="vBig">0.0</span></div>
                <div class="hud-track"><div id="bBig" class="hud-bar" style="width:0%; background:var(--danger)"></div></div>
            </div>
            <div class="hud-item">
                <div class="hud-head"><span>SML</span> <span id="vSml">0.0</span></div>
                <div class="hud-track"><div id="bSml" class="hud-bar" style="width:0%; background:var(--success)"></div></div>
            </div>
            <div class="hud-item">
                <div class="hud-head"><span>ODD</span> <span id="vOdd">0.0</span></div>
                <div class="hud-track"><div id="bOdd" class="hud-bar" style="width:0%; background:var(--purple)"></div></div>
            </div>
            <div class="hud-item">
                <div class="hud-head"><span>EVN</span> <span id="vEvn">0.0</span></div>
                <div class="hud-track"><div id="bEvn" class="hud-bar" style="width:0%; background:var(--cyan)"></div></div>
            </div>
        </div>
        <div class="combo-row">
            <div class="mini-stat"><span class="ms-label" id="cN1">-</span><div class="ms-val c-main" id="cV1">-</div></div>
            <div class="mini-stat"><span class="ms-label" id="cN2">-</span><div class="ms-val c-main" id="cV2">-</div></div>
            <div class="mini-stat"><span class="ms-label" id="cN3">-</span><div class="ms-val c-def" id="cV3">-</div></div>
            <div class="mini-stat"><span class="ms-label" id="cN4">-</span><div class="ms-val c-kill" id="cV4">-</div></div>
        </div>
    </div>

    <div class="card">
        <span class="card-label">TERMINAL LOGS (LAST 10)</span>
        <div id="histList"></div>
    </div>

    <div class="card" style="padding-bottom: 25px;">
        <span class="card-label">ANALYTICS // 六维统计</span>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-t">主力 (MAIN)</span><span id="acc-main" class="stat-v c-main">--%</span></div>
            <div class="stat-box"><span class="stat-t">防守 (DEF)</span><span id="acc-def" class="stat-v c-def">--%</span></div>
            <div class="stat-box"><span class="stat-t">杀组 (KILL)</span><span id="acc-kill" class="stat-v" style="color:var(--danger)">--%</span></div>
            <div class="stat-box"><span class="stat-t">大小 (B/S)</span><span id="acc-bs" class="stat-v">--%</span></div>
            <div class="stat-box"><span class="stat-t">单双 (O/E)</span><span id="acc-oe" class="stat-v">--%</span></div>
            <div class="stat-box"><span class="stat-t">综合 (TOTAL)</span><span id="acc-total" class="stat-v">--%</span></div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        API: "https://pc28.help/kj.json?limit=20",
        REFRESH: 15,
        // 七大公式所需的完整常量集
        C: { 
            SCAL_GOLD: 3.81966, 
            SQRT_OSC: 28.5, 
            SQRT_ADD: 7.5515,
            FISS_GOLD: 1.6180, // 裂变常量
            TRI_DIV: 42.75,    // 三角除数
            REV_GOLD: 0.61803, // 反向黄金分割
            WARN_DIV: 6.6666,  // 警报除数
            EXT_DIV: 2.2222    // 极值除数
        }
    };

    const STATE = { history: [], timer: null };

    const KERNEL = {
        getD: (n) => parseInt(n.toFixed(6).split('.')[1][0]),
        
        // 核心修正：强制转数字，防止字符串导致计算失效
        safeNum: (n) => Number(n) || 0,

        run: (rawN1, rawN2, rawN3, sum, prev, history) => {
            const C = CONFIG.C;
            
            // 1. 数据清洗
            const n1 = KERNEL.safeNum(rawN1);
            const n2 = KERNEL.safeNum(rawN2);
            const n3 = KERNEL.safeNum(rawN3);

            // 2. 基础分降为 10（原来是100），让加减分效果显著
            let seed = (n1 * 1.01 + n2 * 1.02 + n3 * 1.03) * 0.0001;
            let w = { b: 10+seed, s: 10-seed, o: 10+seed, e: 10-seed };
            
            // --- 七大公式核心 (V5 高波动版) ---

            // Algo 19 手术刀 (强力惩罚)
            let r19 = (Math.sqrt(n1**2+n2**2+n3**2))/C.SCAL_GOLD;
            let d19 = KERNEL.getD(r19);
            // 只要触发，直接拉开 50 分差距
            if (d19 >= 5) { w.b += 50; w.s -= 20; } 
            else { w.s += 50; w.b -= 20; }
            
            let i19 = Math.floor(r19);
            if ((i19 + d19) % 2 !== 0) { w.o += 40; w.e -= 15; } 
            else { w.e += 40; w.o -= 15; }

            // Algo 16 几何裂变
            let isDive = Math.abs(n1-n2) > 8;
            let r16 = Math.sqrt(n1*n2*(1+Math.abs(n1-n2)/C.SQRT_OSC)+C.SQRT_ADD);
            let d16 = KERNEL.getD(r16);
            let sc16 = isDive ? 60 : 30; 
            if(d16 >= 5) { w.b += sc16; w.s -= sc16/2; }
            else { w.s += sc16; w.b -= sc16/2; }

            // Algo 14 裂变
            if(prev) {
                let r14 = Math.sqrt(((n1-n2)**2) + ((n3**2)/(sum+1)) + C.FISS_GOLD);
                let d14 = KERNEL.getD(r14);
                let w14 = 25; 
                let prevBs = prev.sum >= 14 ? 'Big' : 'Small';
                if(d14<=4) { 
                    if(prevBs==='Big') w.b+=w14; else w.s+=w14;
                } else {
                    if(prevBs==='Big') w.s+=w14; else w.b+=w14;
                }
            }

            // Algo 18 三角
            let r18 = ((n1+3.1415)*(n2+2.7182)*(n3+1.4142))/C.TRI_DIV;
            (Math.floor(r18)%10%2!==0) ? w.o+=20 : w.e+=20;

            // Algo 2 反转
            let r2 = (n1+C.REV_GOLD)*C.REV_GOLD;
            (Math.floor(r2)%2===0) ? w.o+=15 : w.e+=15;

            // Algo 10 修正
            let r10 = 280/(n1+C.EXT_DIV);
            let dec10 = r10 - Math.floor(r10);
            if(dec10 < 0.333) {
                if(w.b > w.s) w.b *= 0.8; else w.s *= 0.8;
            }

            // Algo 3 熔断 (重置为基础分)
            let r3 = (n1+n2+n3)/C.WARN_DIV;
            let d3 = KERNEL.getD(r3);
            if(d3===0 || d3===6) {
                w.b=10+seed; w.s=10-seed; w.o=10+seed; w.e=10-seed;
            }

            // --- V5 核心：极差放大器 (专治 2.5 平局) ---
            const boost = (k1, k2) => {
                let diff = Math.abs(w[k1] - w[k2]);
                // 如果差距过小，强制给领先者加权
                if(diff < 5) {
                    if(w[k1] > w[k2]) w[k1] += 30; else w[k2] += 30;
                }
            };
            boost('b', 's');
            boost('o', 'e');

            // --- 归一化 (Sum=10) ---
            let minV = Math.min(w.b, w.s, w.o, w.e);
            if(minV < 5) {
                let lift = Math.abs(minV) + 10;
                w.b += lift; w.s += lift; w.o += lift; w.e += lift;
            }

            let totalInd = w.b + w.s + w.o + w.e || 1;
            let nW = {
                b: (w.b / totalInd) * 10,
                s: (w.s / totalInd) * 10,
                o: (w.o / totalInd) * 10,
                e: (w.e / totalInd) * 10
            };

            let combos = [
                { name: "大单", s: w.b + w.o },
                { name: "大双", s: w.b + w.e },
                { name: "小单", s: w.s + w.o },
                { name: "小双", s: w.s + w.e }
            ];

            combos.forEach((c,i) => c.s += i*0.01);
            combos.sort((a,b) => b.s - a.s);

            let totalComb = combos.reduce((a,b)=>a+b.s,0) || 1;
            let nCombos = combos.map(c => ({
                name: c.name,
                s: (c.s / totalComb) * 10
            }));

            return { nW, nCombos };
        }
    };

    const APP = {
        init: () => APP.sync(),
        sync: async () => {
            const timer = document.getElementById('timer');
            const dot = document.querySelector('.pulse-dot');
            timer.innerText = "UPDATING...";
            dot.style.background = "#eab308";

            try {
                const t = Date.now();
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(CONFIG.API + "&t=" + t)}`);
                const json = await res.json();
                const data = JSON.parse(json.contents).data;
                if(data && data.length) {
                    STATE.history = data.map(i => {
                        const n = i.opennum.split('+').map(Number);
                        return { q: i.qihao, n1:n[0], n2:n[1], n3:n[2], sum: parseInt(i.sum) };
                    });
                    APP.render();
                    dot.style.background = "#10b981";
                }
            } catch(e) { 
                console.error(e);
                timer.innerText = "ERROR";
                dot.style.background = "#ef4444";
            }
            APP.startTimer();
        },
        render: () => {
            const list = STATE.history;
            if(list.length < 5) return;
            
            const cur = list[0];
            const res = KERNEL.run(cur.n1, cur.n2, cur.n3, cur.sum, list[1], list);

            // UI - Core
            document.getElementById('tMain').innerHTML = `<span style="color:var(--primary)">${res.nCombos[0].name}</span> <span style="font-size:0.6em;opacity:0.5">/</span> <span style="color:rgba(255,255,255,0.7);font-size:0.8em">${res.nCombos[1].name}</span>`;
            document.getElementById('tDef').innerText = res.nCombos[2].name;
            document.getElementById('tKill').innerText = res.nCombos[3].name;

            // UI - Bars
            const draw = (id, v) => {
                document.getElementById('b'+id).style.width = Math.min(100, v*10) + '%';
                document.getElementById('v'+id).innerText = v.toFixed(1);
            };
            draw('Big', res.nW.b); draw('Sml', res.nW.s);
            draw('Odd', res.nW.o); draw('Evn', res.nW.e);

            // UI - Combos
            for(let i=0; i<4; i++) {
                document.getElementById(`cN${i+1}`).innerText = res.nCombos[i].name;
                document.getElementById(`cV${i+1}`).innerText = res.nCombos[i].s.toFixed(1);
            }

            // Stats & Logs
            APP.calcStats(list);
        },
        calcStats: (list) => {
            const box = document.getElementById('histList');
            box.innerHTML = '';
            let s = { main:0, def:0, kill:0, bs:0, oe:0, total:0 };

            for(let i=0; i<10; i++) {
                if(i+2 >= list.length) break;
                const t = list[i]; // Target
                const inp = list[i+1]; // Input
                const sim = KERNEL.run(inp.n1, inp.n2, inp.n3, inp.sum, list[i+2], list);
                
                const rBig = t.sum >= 14;
                const rOdd = t.sum % 2 !== 0;
                const rStr = (rBig?'大':'小') + (rOdd?'单':'双');

                s.total++;
                let isMain = (sim.nCombos[0].name === rStr || sim.nCombos[1].name === rStr);
                let isDef = (sim.nCombos[2].name === rStr);
                let isKillFail = (sim.nCombos[3].name === rStr);

                if(isMain) s.main++;
                if(isDef) s.def++;
                if(!isKillFail) s.kill++;

                if((sim.nW.b > sim.nW.s) === rBig) s.bs++;
                if((sim.nW.o > sim.nW.e) === rOdd) s.oe++;

                // Tag Logic
                let tag = '', cls = '';
                if(isMain) { tag = 'HIT'; cls = 'tag-hit'; }
                else if(isDef) { tag = 'DEF'; cls = 'tag-def'; }
                else { tag = 'MISS'; cls = 'tag-miss'; }

                box.innerHTML += `
                    <div class="log-row">
                        <div class="log-q">${t.q.slice(-4)}期</div>
                        <div class="log-r">${rStr} <span style="font-size:0.7em; opacity:0.6; margin-left:4px">[${t.sum}]</span></div>
                        <div class="log-res ${cls}">${tag}</div>
                    </div>`;
            }

            const pct = v => Math.round((v/s.total)*100) + "%";
            document.getElementById('acc-main').innerText = pct(s.main);
            document.getElementById('acc-def').innerText = pct(s.def);
            document.getElementById('acc-kill').innerText = pct(s.kill);
            document.getElementById('acc-bs').innerText = pct(s.bs);
            document.getElementById('acc-oe').innerText = pct(s.oe);
            document.getElementById('acc-total').innerText = pct(s.main + s.def);
        },
        startTimer: () => {
            if(STATE.timer) clearInterval(STATE.timer);
            let t = CONFIG.REFRESH;
            STATE.timer = setInterval(() => {
                t--;
                if(t<=0) { clearInterval(STATE.timer); APP.sync(); }
                else document.getElementById('timer').innerText = `NEXT ${t}s`;
            }, 1000);
        }
    };

    window.onload = APP.init;
</script>
</body>
</html>
