<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gemini V5 [Commander]</title>
    <style>
        :root {
            --bg: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --blue: #007aff;
            --green: #34c759;
            --red: #ff3b30;
            --yellow: #ffcc00;
            --shadow-out: 6px 6px 12px #d1d1d6, -6px -6px 12px #ffffff;
            --shadow-in: inset 4px 4px 8px #d1d1d6, inset -4px -4px 8px #ffffff;
            --radius: 20px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container { width: 100%; max-width: 414px; display: flex; flex-direction: column; gap: 20px; }

        /* é¡¶éƒ¨ */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .logo { font-weight: 900; font-size: 1.2rem; letter-spacing: -0.5px; }
        .status-pill { 
            background: var(--bg); padding: 6px 12px; border-radius: 20px; 
            box-shadow: var(--shadow-out); font-size: 0.75rem; font-weight: 700; color: var(--blue);
        }

        /* é€šç”¨å¡ç‰‡ (æ–°æ‹Ÿæ€) */
        .card {
            background: var(--bg); border-radius: var(--radius);
            box-shadow: var(--shadow-out); padding: 20px;
            position: relative;
        }
        .card-title { font-size: 0.8rem; font-weight: 800; color: var(--text-sub); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }

        /* 1. æˆ˜æœ¯è·¯å¾„å¡ */
        .tac-step { display: flex; align-items: flex-start; margin-bottom: 12px; font-size: 0.9rem; }
        .step-num { 
            background: var(--blue); color: white; width: 20px; height: 20px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 0.7rem; font-weight: bold; margin-right: 10px; flex-shrink: 0; margin-top: 2px;
        }
        .step-content { line-height: 1.4; }
        .highlight { font-weight: 800; color: var(--text-main); }
        .warn-text { color: var(--red); font-weight: 700; text-decoration: line-through; }

        /* 2. æƒé‡å±•ç¤ºåŒº */
        .weight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .w-box { text-align: center; padding: 10px; border-radius: 12px; background: #fff; border: 1px solid rgba(0,0,0,0.05); }
        .w-label { font-size: 0.7rem; color: var(--text-sub); }
        .w-score { font-size: 1.2rem; font-weight: 800; margin: 4px 0; }
        .w-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .tag-main { background: rgba(0,122,255,0.1); color: var(--blue); }
        .tag-def { background: rgba(255,204,0,0.2); color: #d4a000; }
        .tag-kill { background: rgba(255,59,48,0.1); color: var(--red); }

        /* 3. æ·±åº¦è§£ææ–‡æœ¬ */
        .analysis-box {
            font-size: 0.85rem; line-height: 1.6; color: #444; 
            background: #fff; padding: 15px; border-radius: 12px; border-left: 4px solid var(--blue);
        }

        /* 4. å†å²å¤ç›˜ */
        .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; }
        .res-pill { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }
        .hit { background: var(--green); color: #fff; box-shadow: 0 2px 5px rgba(52,199,89,0.4); }
        .def { background: var(--yellow); color: #000; }
        .dev { background: var(--red); color: #fff; box-shadow: 0 2px 5px rgba(255,59,48,0.4); }

        /* èƒ½é‡æ¡ */
        .bar-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.75rem; font-weight: 600; }
        .track { flex: 1; height: 6px; background: #e5e5ea; border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        
        /* é¢œè‰²ç±» */
        .c-main { color: var(--blue); }
        .c-def { color: #d4a000; }
        .c-kill { color: var(--red); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div class="logo">GEMINI V5.0</div>
        <div class="status-pill" id="timer">LOADING...</div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ”¥ æ ¸å¿ƒæˆ˜æœ¯è·¯å¾„ / TACTICAL PATH</div>
        
        <div class="tac-step">
            <div class="step-num">1</div>
            <div class="step-content">
                <strong>ä¸»åŠ›å‹åˆ¶ (Main):</strong> <span id="txtMain" class="highlight c-main">--</span><br>
                <span style="font-size:0.75rem; color:#666;">ç†ç”±: èƒ½é‡è¯„åˆ† <span id="scoreMain">--</span>ï¼Œä¸” Algo 19 é”å®šé‡åŠ›ä½ã€‚</span>
            </div>
        </div>
        
        <div class="tac-step">
            <div class="step-num">2</div>
            <div class="step-content">
                <strong>å£è¢‹æ‹¦æˆª (Defense):</strong> <span id="txtDef" class="highlight c-def">--</span><br>
                <span style="font-size:0.75rem; color:#666;">ç†ç”±: é˜²å®ˆå¯¹å†²ä½ï¼Œé˜²æ­¢ V5 ç®—æ³•å‡ºç°çœŸç©ºæº¢å‡ºã€‚</span>
            </div>
        </div>

        <div class="tac-step">
            <div class="step-num">3</div>
            <div class="step-content">
                <strong>ç»æ€åºŸç»„ (Kill Zone):</strong> <span id="txtKill" class="warn-text">--</span><br>
                <span style="font-size:0.75rem; color:#666;">æŒ‡ä»¤: èƒ½é‡å€¼å«åº•ï¼Œåšå†³é¿å¼€ã€‚</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“Š èƒ½é‡æƒé‡ (10åˆ†åˆ¶)</div>
        <div class="bar-wrap"><span style="width:30px">å¤§</span><div class="track"><div id="barBig" class="fill" style="background:var(--red)"></div></div><span id="vBig">0</span></div>
        <div class="bar-wrap"><span style="width:30px">å°</span><div class="track"><div id="barSml" class="fill" style="background:var(--green)"></div></div><span id="vSml">0</span></div>
        <div class="bar-wrap"><span style="width:30px">å•</span><div class="track"><div id="barOdd" class="fill" style="background:var(--blue)"></div></div><span id="vOdd">0</span></div>
        <div class="bar-wrap"><span style="width:30px">åŒ</span><div class="track"><div id="barEvn" class="fill" style="background:var(--yellow)"></div></div><span id="vEvn">0</span></div>
        
        <div style="height:1px; background:#e5e5ea; margin:15px 0;"></div>
        
        <div class="card-title">ğŸ§© ç»„åˆæƒé‡ (10åˆ†åˆ¶)</div>
        <div class="weight-grid" id="comboGrid">
            </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ§  é€»è¾‘æ·±åº¦è§£æ / DEEP DIVE</div>
        <div class="analysis-box" id="analysisText">
            æ•°æ®è½½å…¥ä¸­ï¼Œæ­£åœ¨å»ºç«‹ç¦»æ•£åº¦åŸºå‡†...
        </div>
    </div>

    <div class="card">
        <div class="card-title">âš”ï¸ æˆ˜æœå¤ç›˜ / REVIEW</div>
        <div id="histList"></div>
    </div>

</div>

<script>
    // --- æ ¸å¿ƒå¸¸é‡ ---
    const C = {
        SQRT_OSC: 28.5, SQRT_ADD: 7.5515, FISS_GOLD: 1.6180, SCAL_GOLD: 3.81966,
        TRI_DIV: 42.75, REV_GOLD: 0.61803, WARN_DIV: 6.6666, EXT_DIV: 2.2222
    };

    const STATE = {
        api: "https://pc28.help/kj.json?limit=50",
        history: [],
        lastMissKey: null, // ç”¨äºè·¨å‘¨æœŸæˆªæ€è¡¥å¿
        refresh: 20
    };

    const KERNEL = {
        getD: (n) => parseInt(n.toFixed(6).split('.')[1][0]),
        getI: (n) => Math.floor(n),

        // æ ¸å¿ƒè¿ç®—
        run: (n1, n2, n3, sum, history) => {
            let w = { b:0, s:0, o:0, e:0 };
            let logs = []; // é€»è¾‘æ—¥å¿—

            // 1. å†·å¯åŠ¨å–‚å…» (ç¦»æ•£åº¦åˆ†æ)
            let volatility = 0;
            if(history.length >= 10) {
                let sums = history.slice(0, 10).map(h => h.sum);
                let avg = sums.reduce((a,b)=>a+b,0)/10;
                volatility = Math.sqrt(sums.map(x => (x-avg)**2).reduce((a,b)=>a+b,0)/10);
                logs.push(`[å†·å¯åŠ¨] è¿‘10æœŸç¦»æ•£åº¦ ${volatility.toFixed(2)}ï¼ŒåŸºå‡†å·²å»ºç«‹ã€‚`);
            }

            // 2. ç®—æ³•çŸ©é˜µæ‰§è¡Œ (å…¨ä¿ç•™)
            // Algo 19 (P0)
            let r19 = (Math.sqrt(n1**2+n2**2+n3**2))/C.SCAL_GOLD;
            let d19 = KERNEL.getD(r19);
            let i19 = KERNEL.getI(r19);
            if([7,8,9].includes(d19)) { w.b+=10; logs.push(`[Algo19] D=${d19} é‡åŠ›ä½æŒ‡å‘å¤§ã€‚`); }
            else if([0,1,2].includes(d19)) { w.s+=10; logs.push(`[Algo19] D=${d19} é‡åŠ›ä½æŒ‡å‘å°ã€‚`); }
            if([3,4,5,6].includes(d19)) {
                if((i19+n1+n2)%3===0) { w.o+=10; logs.push(`[Algo19] ç†µå€¼é”å®šå•ã€‚`); }
                else { w.e+=10; logs.push(`[Algo19] ç†µå€¼é”å®šåŒã€‚`); }
            }

            // Algo 16 (P1)
            let isDiving = Math.abs(n1-n2)>8;
            let r16 = Math.sqrt(n1*n2*(1+Math.abs(n1-n2)/C.SQRT_OSC)+C.SQRT_ADD);
            let d16 = KERNEL.getD(r16);
            let s16 = isDiving ? 10 : 5;
            if(d16>=5) w.b+=s16; else w.s+=s16;
            if(isDiving) logs.push(`[Algo16] è·³æ°´ç‹¬è£è§¦å‘ (Diff=${Math.abs(n1-n2)})ã€‚`);

            // Algo 14 (P1)
            let r14 = Math.sqrt(((n1-n2)**2) + ((n3**2)/(sum+1)) + C.FISS_GOLD);
            let d14 = KERNEL.getD(r14);
            let dir14 = (d14<=4) ? 'é¡º' : 'è£‚';
            let w14 = 4;
            if(dir14==='é¡º') { 
                if(w.b>w.s) w.b+=w14; else w.s+=w14; 
                logs.push(`[Algo14] é¡ºåŠ¿å½¢æ€ï¼Œèƒ½é‡å…±æŒ¯ã€‚`);
            } else { 
                if(w.b>w.s) w.s+=w14; else w.b+=w14; 
                logs.push(`[Algo14] è£‚å˜å½¢æ€ï¼Œé¢„é˜²åè½¬ã€‚`);
            }

            // Algo 18, 2, 3, 10 (Standard execution)
            let r18 = ((n1+3.1415)*(n2+2.7182)*(n3+1.4142))/C.TRI_DIV;
            let u18 = Math.floor(r18)%10;
            (u18%2!==0) ? w.o+=3 : w.e+=3;
            
            let r2 = (n1+C.REV_GOLD)*C.REV_GOLD;
            (Math.floor(r2)%2===0) ? w.o+=3 : w.e+=3;

            let r3 = (n1+n2+n3)/C.WARN_DIV;
            let d3 = KERNEL.getD(r3);
            if(d3===0 || d3===6) {
                logs.push(`[Algo3] âš ï¸ åè¶‹åŠ¿è­¦æŠ¥ (D=${d3})ï¼Œå¼ºåˆ¶æ¸…ç©ºæƒ¯æ€§ï¼`);
                w.b*=0.5; w.s*=0.5; w.o*=0.5; w.e*=0.5;
            }

            let r10 = 280/(n1+C.EXT_DIV);
            let dec10 = r10 - Math.floor(r10);
            if(dec10 < 0.333) {
                logs.push(`[Algo10] è§¦åº•åå¼¹ä¿¡å·ï¼Œå¯åŠ¨é˜²å¾¡å¯¹å†²ã€‚`);
                if(w.b>w.s) w.s+=4; else w.b+=4;
            }

            // 3. ä¸»åŠ›ä½æƒé‡å¼ºåˆ¶åç§» (7.5-8.5)
            let maxS = Math.max(w.b,w.s,w.o,w.e);
            if(maxS >= 7.5 && maxS <= 8.5) {
                logs.push(`[å°´å°¬åŒºä¿®æ­£] æƒé‡å¡åœ¨ ${maxS.toFixed(1)}ï¼Œæ¿€æ´» MOD 3 å¼ºé”ã€‚`);
                let lock = (i19 + n1 + n2) % 3;
                if(lock === 0) w.o += 5; else w.e += 5;
            }

            // 4. è·¨å‘¨æœŸæˆªæ€ (è¡¥å¿)
            if(STATE.lastMissKey) {
                logs.push(`[å¤ä»‡æ¨¡å¼] ä¸ŠæœŸ ${STATE.lastMissKey} åç¦»ï¼Œæœ¬æœŸå¼ºåˆ¶è¡¥å¿ +1.5ã€‚`);
                if(STATE.lastMissKey.includes('å¤§')) w.b+=1.5;
                if(STATE.lastMissKey.includes('å°')) w.s+=1.5;
                if(STATE.lastMissKey.includes('å•')) w.o+=1.5;
                if(STATE.lastMissKey.includes('åŒ')) w.e+=1.5;
            }

            // ç»„åˆè®¡ç®—
            let combos = [
                { name: "å¤§å•", s: w.b+w.o }, { name: "å¤§åŒ", s: w.b+w.e },
                { name: "å°å•", s: w.s+w.o }, { name: "å°åŒ", s: w.s+w.e }
            ];
            combos.sort((a,b) => b.s - a.s);

            return { w, combos, logs };
        }
    };

    // --- Controller ---
    async function sync() {
        document.getElementById('timer').innerText = "SYNC...";
        try {
            const t = Date.now();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(STATE.api + "&t=" + t)}`);
            const json = await res.json();
            const data = JSON.parse(json.contents).data;
            if(data && data.length > 0) {
                STATE.history = data.map(i => {
                    const nums = i.opennum.split('+').map(Number);
                    return { q: i.qihao, n1: nums[0], n2: nums[1], n3: nums[2], sum: parseInt(i.sum) };
                });
                render();
            }
        } catch(e) { console.error(e); }
        startTimer();
    }

    function render() {
        const list = STATE.history;
        if(list.length < 5) return;

        // 1. é¢„æµ‹æœ¬æœŸ (åŸºäº list[0])
        const cur = list[0];
        const res = KERNEL.run(cur.n1, cur.n2, cur.n3, cur.sum, list);
        
        // --- æˆ˜æœ¯è·¯å¾„æ¸²æŸ“ ---
        const mainCombo = res.combos[0]; // ä¸»åŠ›1 (ç¬¬ä¸€å)
        const subCombo = res.combos[1];  // ä¸»åŠ›2 (ç¬¬äºŒå) - è¾…åŠ©ä¸»åŠ›
        const defCombo = res.combos[2];  // é˜²å®ˆ (ç¬¬ä¸‰å)
        const killCombo = res.combos[3]; // æ€ç»„ (å€’æ•°ç¬¬ä¸€)

        document.getElementById('txtMain').innerText = `${mainCombo.name} / ${subCombo.name}`;
        document.getElementById('scoreMain').innerText = mainCombo.s.toFixed(1);
        
        document.getElementById('txtDef').innerText = defCombo.name;
        document.getElementById('txtKill').innerText = killCombo.name;

        // --- æƒé‡é¢æ¿æ¸²æŸ“ ---
        // å•é¡¹
        const setBar = (id, val) => {
            document.getElementById('bar'+id).style.width = Math.min(100, val*5) + '%';
            document.getElementById('v'+id).innerText = val.toFixed(1);
        };
        setBar('Big', res.w.b); setBar('Sml', res.w.s);
        setBar('Odd', res.w.o); setBar('Evn', res.w.e);

        // ç»„åˆ
        const grid = document.getElementById('comboGrid');
        grid.innerHTML = '';
        res.combos.forEach((c, idx) => {
            let tag = '';
            if(idx <= 1) tag = 'tag-main';
            else if(idx === 2) tag = 'tag-def';
            else tag = 'tag-kill';
            
            let label = idx<=1 ? 'ä¸»åŠ›' : (idx===2 ? 'é˜²å®ˆ' : 'æ€ç»„');
            
            grid.innerHTML += `
                <div class="w-box">
                    <div class="w-label">${c.name} <span class="w-tag ${tag}">${label}</span></div>
                    <div class="w-score">${c.s.toFixed(1)}</div>
                </div>`;
        });

        // --- æ·±åº¦è§£ææ¸²æŸ“ ---
        document.getElementById('analysisText').innerHTML = res.logs.join('<br>');

        // --- æˆ˜æœå¤ç›˜ (æ ¸å¿ƒé€»è¾‘) ---
        const hBox = document.getElementById('histList');
        hBox.innerHTML = '';
        
        // è®°å½•ä¸Šä¸€æŠŠçš„ç»“æœç”¨äºä¸‹æŠŠè¡¥å¿
        STATE.lastMissKey = null;

        for(let i=0; i<10; i++) {
            const target = list[i];
            const prev = list[i+1];
            // å›æµ‹ï¼šç”¨ä¸Šä¸€æœŸé¢„æµ‹è¿™ä¸€æœŸ
            const sim = KERNEL.run(prev.n1, prev.n2, prev.n3, prev.sum, list.slice(i+1));
            
            const actBs = target.sum >= 14 ? 'å¤§' : 'å°';
            const actOe = target.sum % 2 !== 0 ? 'å•' : 'åŒ';
            const actName = actBs + actOe; // e.g. "å¤§å•"
            
            // åˆ¤å®šé€»è¾‘:
            // ä¸»åŠ›ä¸­ (å‰ä¸¤åå«ç»“æœ) -> å‘½ä¸­ (Green)
            // é˜²å®ˆä¸­ (ç¬¬ä¸‰åæ˜¯ç»“æœ) -> é˜²å®ˆ (Yellow)
            // æ€ç»„ä¸­ (æœ€åä¸€åæ˜¯ç»“æœ) -> åç¦» (Red)
            
            let statusHtml = '';
            let isHit = false;
            
            if(sim.combos[0].name === actName || sim.combos[1].name === actName) {
                statusHtml = `<span class="res-pill hit">å‘½ä¸­</span>`;
                isHit = true;
            } else if (sim.combos[2].name === actName) {
                statusHtml = `<span class="res-pill def">é˜²å®ˆ</span>`;
            } else {
                statusHtml = `<span class="res-pill dev">åç¦»</span>`;
            }

            // å¦‚æœæ˜¯æœ€æ–°çš„ä¸€æœŸ(i=0)ä¸”åç¦»äº†ï¼Œè®¾ç½®è¡¥å¿Key
            if(i === 0 && !isHit) {
                // è¡¥å¿ç­–ç•¥ï¼šåšæŒä¸Šä¸€æŠŠçš„ä¸»åŠ›æ–¹å‘
                STATE.lastMissKey = sim.combos[0].name;
            }

            hBox.innerHTML += `
                <div class="hist-item">
                    <div>
                        <div style="font-weight:700;">${target.q.slice(-4)}æœŸ <span style="font-weight:400; color:#888;">[${target.sum}]</span></div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-weight:700; margin-right:8px; color:#444;">${actName}</span>
                        ${statusHtml}
                    </div>
                </div>`;
        }
    }

    function startTimer() {
        let t = STATE.refresh;
        const tmr = setInterval(() => {
            t--;
            document.getElementById('timer').innerText = `NEXT ${t}s`;
            if(t<=0) { clearInterval(tmr); sync(); }
        }, 1000);
    }

    window.onload = sync;
</script>
</body>
</html>
